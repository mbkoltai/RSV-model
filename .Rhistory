full_output_mean_age = npi_scan_sum_infs_by_age %>% group_by(dep_type) %>% mutate(dep_val=as.numeric(factor(dep_val))) %>%
group_by(epi_year,par_id,dep_type,dep_val,R0,seasforce_peak,npi_str) %>%
summarise(mean_age=sum((sum_inf/sum(sum_inf))*mean_age_weighted),
mean_age_under_5=sum((sum_inf[agegroup<=7]/sum(sum_inf[agegroup<=7]))*mean_age_weighted[agegroup<=7]),
mean_age_under_15=sum((sum_inf[agegroup<=8]/sum(sum_inf[agegroup<=8]))*mean_age_weighted[agegroup<=8])) %>%
group_by(par_id,npi_str) %>% mutate(
`shift in average age of infection <5y`=ifelse(epi_year>=2021,mean_age_under_5[epi_year==2021]-mean(mean_age_under_5[epi_year<2020]),NA),
`shift in average age of infection <15y`=ifelse(epi_year>=2021,mean_age_under_15[epi_year==2021]-mean(mean_age_under_15[epi_year<2020]),NA))
df_plot_mean_age_shift <- full_output_mean_age %>% pivot_longer(!c(epi_year,par_id,dep_type,dep_val,R0,seasforce_peak,npi_str)) %>%
group_by(name,epi_year,par_id,dep_val,dep_type,R0,seasforce_peak) %>%
summarise(mean_val=mean(value),min_npi_val=min(value),max_npi_val=max(value)) %>% filter(epi_year==2021 & grepl("shift",name)) %>%
mutate(dep_type=ifelse(grepl("age",dep_type),"~age","~immunity")) %>% ungroup()
ratio_diff_flag <- "shift"
title_str=ifelse(ratio_diff_flag=="shift","shift (in months) from 2019 to 2021","(mean age in 2021)/(mean age in 2019)")
colorpal=c(colorRampPalette(colors=c("orange","red"))(uni_dep_vals[1]),colorRampPalette(colors=c("darkgrey","black"))(uni_dep_vals[2]))
ratio_diff_flag <- "shift"
title_str=ifelse(ratio_diff_flag=="shift","shift (in months) from 2019 to 2021","(mean age in 2021)/(mean age in 2019)")
ggplot(df_plot_mean_age_shift %>% filter(grepl("<",name)) %>%
mutate(name=factor(name,levels=c("shift in average age of infection <5y","shift in average age of infection <15y"))) %>%
mutate(type_R0=paste0(dep_type,", R0=",R0)),
aes(x=factor(dep_val),y=mean_val*12,group=interaction(seasforce_peak,type_R0),size=seasforce_peak)) +
geom_point(aes(color=type_R0),position=position_dodge(width=dodge_val)) + scale_size(range=c(0.7,2)/2.5) +
geom_pointrange(aes(color=type_R0,ymin=min_npi_val*12,ymax=max_npi_val*12),position=position_dodge(width=dodge_val)) +
facet_wrap(~name,scales="free") + scale_color_manual(values=colorpal) + geom_vline(xintercept=0.5+0:8,linetype="dashed",size=1/3) +
xlab("strength of dependence on age/exposure") + ylab(title_str) + labs(color=paste0(""),size="seasonal forcing (>baseline)") +
theme_bw() + standard_theme + scale_x_discrete(expand=expansion(0.12,0)) + guides(color=guide_legend(ncol=3)) + # ,byrow=TRUE
theme(legend.position="top",axis.title.x=element_text(size=15),axis.text.x=element_text(size=15),axis.text.y=element_text(size=15),
strip.text=element_text(size=15),legend.text=element_text(size=13),legend.title=element_text(size=14))
# save
ggsave(paste0(foldername,"resurgence_mean_age_",ratio_diff_flag,"_2021_2019.png"),width=43,height=25,units="cm")
unique(npi_scan_sum_infs_by_age$dep_val)
agegrp_yr<-paste0(c("0-1","1-2","2-3","3-4","4-5","5-15",">15"),"y")
sum_max_ratio_by_yearly_agegr <- npi_scan_sum_infs_by_age %>% group_by(dep_type) %>% mutate(dep_val=as.numeric(factor(dep_val))) %>%
mutate(age_yr=agegrp_yr[findInterval(agegroup,c(0,3,5,6,7,8,9))]) %>%
group_by(epi_year,par_id,dep_type,dep_val,R0,seasforce_peak,npi_str,age_yr) %>%
summarise(sum_inf=sum(sum_inf),max_inf=sum(max_inf),peak_week=mean(peak_week),resurg_week_20pct=mean(resurg_week_20pct)) %>%
group_by(par_id,npi_str,age_yr) %>% mutate(sum_ratio=ifelse(epi_year>=2021,sum_inf[epi_year==2021]/mean(sum_inf[epi_year<2020]),NA),
max_ratio=ifelse(epi_year>=2021,max_inf[epi_year==2021]/mean(max_inf[epi_year<2020]),NA),
shift_peak_week=ifelse(epi_year>=2021,
ifelse(peak_week[epi_year==2021]<10,peak_week[epi_year==2021]+52,peak_week[epi_year==2021])-
mean(ifelse(peak_week[epi_year<2020]<10,peak_week[epi_year<2020]+52,peak_week[epi_year<2020])),NA),
shift_seasonstart_week=ifelse(epi_year>=2021,
ifelse(resurg_week_20pct[epi_year==2021]<10,resurg_week_20pct[epi_year==2021]+52,resurg_week_20pct[epi_year==2021])-
mean(ifelse(resurg_week_20pct[epi_year<2020]<10,resurg_week_20pct[epi_year<2020]+52,resurg_week_20pct[epi_year<2020])),NA))
unique(npi_scan_sum_infs_by_age$dep_val)
unique(sum_max_ratio_by_yearly_agegr$dep_val)
df_plot_yr_cum_inf <- sum_max_ratio_by_yearly_agegr %>% filter(epi_year==2021 & !grepl(">15y",age_yr)) %>%
mutate(dep_type=ifelse(grepl("age",dep_type),"~age","~immunity")) %>% group_by(age_yr,dep_type,dep_val,R0) %>% # ,par_id ,seasforce_peak
summarise(mean_val=mean(sum_ratio),min_npi_val=min(sum_ratio),max_npi_val=max(sum_ratio) ) %>% ungroup() %>%
mutate(type_R0=factor(paste0(dep_type,", R0=",R0)) )
df_plot_yr_cum_inf <- sum_max_ratio_by_yearly_agegr %>% filter(epi_year==2021 & !grepl(">15y",age_yr)) %>%
mutate(dep_type=ifelse(grepl("age",dep_type),"~age","~immunity")) %>% group_by(age_yr,dep_type,dep_val,R0) %>% # ,par_id ,seasforce_peak
summarise(mean_val=mean(sum_ratio),min_npi_val=min(sum_ratio),max_npi_val=max(sum_ratio) ) %>% ungroup() %>%
mutate(type_R0=factor(paste0(dep_type,", R0=",R0)) )
# filter(dep_val %in% joint_dep_vals) %>% mutate(dep_val=as.numeric(factor(dep_val))) %>%
# plot params
varname <- "sum_ratio"
# uni_dep_vals=(df_plot_yr_cum_inf %>% group_by(dep_type) %>% summarise(n=length(unique(R0))))$n
# colorpal=c(colorRampPalette(colors=c("orange","red"))(uni_dep_vals[1]),colorRampPalette(colors=c("grey","black"))(uni_dep_vals[2]))
title_str <- ifelse(!grepl("ratio",varname),"shift in peak incidence week","ratio of cumulative infections 2021 to 2019"); dodge_val=1
# plot
ggplot(df_plot_yr_cum_inf,aes(x=factor(dep_val),y=mean_val,color=type_R0,group=interaction(type_R0))) + # ,size=seasforce_peak
geom_point(position=position_dodge(width=dodge_val)) + scale_size(range=c(0.7,2)/3) +
geom_pointrange(aes(ymin=min_npi_val,ymax=max_npi_val),position=position_dodge(width=dodge_val)) +
facet_wrap(~age_yr,scales="free",nrow=3) + scale_color_manual(values=colorpal) +
geom_vline(xintercept=0.5+(0:8),linetype="dashed",size=1/3) + # guides(color=guide_legend(ncol=5,byrow=TRUE)) +
xlab("dependence on age/immunity") + ylab(title_str) + labs(size="seasonal forcing (above baseline)",color="") +
theme_bw() + standard_theme  + scale_x_discrete(expand=expansion(0.1,0)) + theme(legend.position="top",
axis.title.x=element_text(size=16),axis.title.y=element_text(size=16),axis.text.x=element_text(size=16),axis.text.y=element_text(size=16),
strip.text=element_text(size=15),legend.text=element_text(size=13),legend.title=element_text(size=14))
ggsave(paste0(foldername,"resurgence_",varname,"_2021_2019_agegr_yrly_seasfor_averaged.png"),width=35,height=25,units="cm")
df_plot_yr_cum_inf <- sum_max_ratio_by_yearly_agegr %>% filter(epi_year==2021 & !grepl(">15y",age_yr)) %>%
mutate(dep_type=ifelse(grepl("age",dep_type),"~age","~immunity")) %>% group_by(age_yr,dep_type,dep_val,R0,seasforce_peak) %>% # ,par_id
summarise(mean_val=mean(sum_ratio),min_npi_val=min(sum_ratio),max_npi_val=max(sum_ratio) ) %>% ungroup() %>%
mutate(type_R0=factor(paste0(dep_type,", R0=",R0)) )
# filter(dep_val %in% joint_dep_vals) %>% mutate(dep_val=as.numeric(factor(dep_val))) %>%
# plot params
varname <- "sum_ratio"
# uni_dep_vals=(df_plot_yr_cum_inf %>% group_by(dep_type) %>% summarise(n=length(unique(R0))))$n
# colorpal=c(colorRampPalette(colors=c("orange","red"))(uni_dep_vals[1]),colorRampPalette(colors=c("grey","black"))(uni_dep_vals[2]))
title_str <- ifelse(!grepl("ratio",varname),"shift in peak incidence week","ratio of cumulative infections 2021 to 2019"); dodge_val=1
# plot
ggplot(df_plot_yr_cum_inf,aes(x=factor(dep_val),y=mean_val,color=type_R0,group=interaction(seasforce_peak,type_R0),size=seasforce_peak)) + #
geom_point(position=position_dodge(width=dodge_val)) + scale_size(range=c(0.7,2)/3) +
geom_pointrange(aes(ymin=min_npi_val,ymax=max_npi_val),position=position_dodge(width=dodge_val)) +
facet_wrap(~age_yr,scales="free",nrow=3) + scale_color_manual(values=colorpal) +
geom_vline(xintercept=0.5+(0:8),linetype="dashed",size=1/3) + # guides(color=guide_legend(ncol=5,byrow=TRUE)) +
xlab("dependence on age/immunity") + ylab(title_str) + labs(size="seasonal forcing (above baseline)",color="") +
theme_bw() + standard_theme  + scale_x_discrete(expand=expansion(0.1,0)) + theme(legend.position="top",
axis.title.x=element_text(size=16),axis.title.y=element_text(size=16),axis.text.x=element_text(size=16),axis.text.y=element_text(size=16),
strip.text=element_text(size=15),legend.text=element_text(size=13),legend.title=element_text(size=14))
ggsave(paste0(foldername,"resurgence_",varname,"_2021_2019_agegr_yrly_seasfor_sep.png"),width=40,height=30,units="cm")
sel_var<-"shift_seasonstart_week" # !!sym(sel_var)
df_plot_yr_seas_timing <- sum_max_ratio_by_yearly_agegr %>% filter(epi_year==2021 & !grepl(">15y",age_yr)) %>%
mutate(dep_type=ifelse(grepl("age",dep_type),"~age","~immunity")) %>% ungroup() %>%
filter(dep_val %in% joint_dep_vals) %>% mutate(dep_val=as.numeric(factor(dep_val))) %>%
group_by(age_yr,dep_type,dep_val,R0) %>% # ,seasforce_peak
summarise(mean_val=abs(mean(!!sym(sel_var))),min_npi_val=abs(min(!!sym(sel_var))),max_npi_val=abs(max(!!sym(sel_var))) ) %>% ungroup() %>%
mutate(type_R0=factor(paste0(dep_type,", R0=",R0)) )
# seas timing
ggplot(df_plot_yr_seas_timing,aes(x=factor(dep_val),y=mean_val,color=type_R0,group=interaction(type_R0))) + # ,size=seasforce_peak
geom_point(position=position_dodge(width=dodge_val)) + scale_size(range=c(0.7,2)/3.5) +
geom_pointrange(aes(ymin=min_npi_val,ymax=max_npi_val),position=position_dodge(width=dodge_val)) +
facet_wrap(~age_yr,scales="free",nrow=3) + scale_color_manual(values=colorpal) +
geom_vline(xintercept=0.5+(0:8),linetype="dashed",size=1/3) + # guides(color=guide_legend(ncol=5,byrow=TRUE)) +
xlab("dependence on age/exp") + ylab(paste0("forward shift in season ",ifelse(grepl("start",sel_var),"start","peak"))) +
labs(size="seasonal forcing (+baseline)",color="") + theme_bw() + standard_theme  + scale_x_discrete(expand=expansion(0.1,0)) +
theme(legend.position="top",axis.title.x=element_text(size=18),axis.title.y=element_text(size=18),
axis.text.x=element_text(size=16),axis.text.y=element_text(size=16),
strip.text=element_text(size=15),legend.text=element_text(size=13),legend.title=element_text(size=14))
# SAVE
df_plot_yr_seas_timing <- sum_max_ratio_by_yearly_agegr %>% filter(epi_year==2021 & !grepl(">15y",age_yr)) %>%
mutate(dep_type=ifelse(grepl("age",dep_type),"~age","~immunity")) %>% ungroup() %>%
group_by(age_yr,dep_type,dep_val,R0) %>% # ,seasforce_peak
summarise(mean_val=abs(mean(!!sym(sel_var))),min_npi_val=abs(min(!!sym(sel_var))),max_npi_val=abs(max(!!sym(sel_var))) ) %>% ungroup() %>%
mutate(type_R0=factor(paste0(dep_type,", R0=",R0)) )
#  filter(dep_val %in% joint_dep_vals) %>% mutate(dep_val=as.numeric(factor(dep_val))) %>%
# seas timing
ggplot(df_plot_yr_seas_timing,aes(x=factor(dep_val),y=mean_val,color=type_R0,group=interaction(type_R0))) + # ,size=seasforce_peak
geom_point(position=position_dodge(width=dodge_val)) + scale_size(range=c(0.7,2)/3.5) +
geom_pointrange(aes(ymin=min_npi_val,ymax=max_npi_val),position=position_dodge(width=dodge_val)) +
facet_wrap(~age_yr,scales="free",nrow=3) + scale_color_manual(values=colorpal) +
geom_vline(xintercept=0.5+(0:8),linetype="dashed",size=1/3) + # guides(color=guide_legend(ncol=5,byrow=TRUE)) +
xlab("dependence on age/exp") + ylab(paste0("forward shift in season ",ifelse(grepl("start",sel_var),"start","peak"))) +
labs(size="seasonal forcing (+baseline)",color="") + theme_bw() + standard_theme  + scale_x_discrete(expand=expansion(0.1,0)) +
theme(legend.position="top",axis.title.x=element_text(size=18),axis.title.y=element_text(size=18),
axis.text.x=element_text(size=16),axis.text.y=element_text(size=16),
strip.text=element_text(size=15),legend.text=element_text(size=13),legend.title=element_text(size=14))
ggsave(paste0(foldername,"resurgence_shift_",ifelse(grepl("start",sel_var),"start","peak"),"week_2021_2019_agegr_yrly_seasfor_aver.png"),
width=40,height=30,units="cm")
df_plot_yr_seas_timing <- sum_max_ratio_by_yearly_agegr %>% filter(epi_year==2021 & !grepl(">15y",age_yr)) %>%
mutate(dep_type=ifelse(grepl("age",dep_type),"~age","~immunity")) %>% ungroup() %>%
group_by(age_yr,dep_type,dep_val,R0,seasforce_peak) %>% #
summarise(mean_val=abs(mean(!!sym(sel_var))),min_npi_val=abs(min(!!sym(sel_var))),max_npi_val=abs(max(!!sym(sel_var))) ) %>% ungroup() %>%
mutate(type_R0=factor(paste0(dep_type,", R0=",R0)) )
#  filter(dep_val %in% joint_dep_vals) %>% mutate(dep_val=as.numeric(factor(dep_val))) %>%
# seas timing
ggplot(df_plot_yr_seas_timing,aes(x=factor(dep_val),y=mean_val,color=type_R0,group=interaction(seasforce_peak,type_R0),size=seasforce_peak)) + #
geom_point(position=position_dodge(width=dodge_val)) + scale_size(range=c(0.7,2)/3.5) +
geom_pointrange(aes(ymin=min_npi_val,ymax=max_npi_val),position=position_dodge(width=dodge_val)) +
facet_wrap(~age_yr,scales="free",nrow=3) + scale_color_manual(values=colorpal) +
geom_vline(xintercept=0.5+(0:8),linetype="dashed",size=1/3) + # guides(color=guide_legend(ncol=5,byrow=TRUE)) +
xlab("dependence on age/exp") + ylab(paste0("forward shift in season ",ifelse(grepl("start",sel_var),"start","peak"))) +
labs(size="seasonal forcing (+baseline)",color="") + theme_bw() + standard_theme  + scale_x_discrete(expand=expansion(0.1,0)) +
theme(legend.position="top",axis.title.x=element_text(size=18),axis.title.y=element_text(size=18),
axis.text.x=element_text(size=16),axis.text.y=element_text(size=16),
strip.text=element_text(size=15),legend.text=element_text(size=13),legend.title=element_text(size=14))
ggsave(paste0(foldername,"resurgence_shift_",ifelse(grepl("start",sel_var),"start","peak"),"week_2021_2019_agegr_yrly_seasfor_separate.png"),
width=40,height=30,units="cm")
View(df_suscept)
0.05299/0.01177
0.04416/0.02061
0.05299/0.03238
npi_dates
seas_conc_lim
peak_week_lims
0.15593/0.01047
0.07174/0.01159
0.02550/0.01765
0.07773/0.01227
ggplot(df_plot_yr_seas_timing,aes(x=factor(dep_val),y=mean_val,color=type_R0,group=interaction(seasforce_peak,type_R0),size=seasforce_peak)) + #
geom_point(position=position_dodge(width=dodge_val)) + scale_size(range=c(0.7,2)/3.5) +
geom_pointrange(aes(ymin=min_npi_val,ymax=max_npi_val),position=position_dodge(width=dodge_val)) +
facet_wrap(~age_yr,scales="free",nrow=3) + scale_color_manual(values=colorpal) +
geom_vline(xintercept=0.5+(0:8),linetype="dashed",size=1/3) + # guides(color=guide_legend(ncol=5,byrow=TRUE)) +
xlab("dependence on age/exp") + ylab(paste0("forward shift in season ",ifelse(grepl("start",sel_var),"start","peak")," (weeks)")) +
labs(size="seasonal forcing (+baseline)",color="") + theme_bw() + standard_theme  + scale_x_discrete(expand=expansion(0.1,0)) +
theme(legend.position="top",axis.title.x=element_text(size=18),axis.title.y=element_text(size=18),legend.title=element_text(size=14),
axis.text.x=element_text(size=16),axis.text.y=element_text(size=16),strip.text=element_text(size=15),legend.text=element_text(size=13))
ggsave(paste0(foldername,"resurgence_shift_",ifelse(grepl("start",sel_var),"start","peak"),"week_2021_2019_agegr_yrly_seasfor_separate.png"),
width=40,height=30,units="cm")
sel_var<-"shift_seasonstart_week" # !!sym(sel_var)
df_plot_yr_seas_timing <- sum_max_ratio_by_yearly_agegr %>% filter(epi_year==2021 & !grepl(">15y",age_yr)) %>%
mutate(dep_type=ifelse(grepl("age",dep_type),"~age","~immunity")) %>% ungroup() %>%
group_by(age_yr,dep_type,dep_val,R0) %>% # ,seasforce_peak
summarise(mean_val=abs(mean(!!sym(sel_var))),min_npi_val=abs(min(!!sym(sel_var))),max_npi_val=abs(max(!!sym(sel_var))) ) %>% ungroup() %>%
mutate(type_R0=factor(paste0(dep_type,", R0=",R0)) )
#  filter(dep_val %in% joint_dep_vals) %>% mutate(dep_val=as.numeric(factor(dep_val))) %>%
# seas timing
ggplot(df_plot_yr_seas_timing,aes(x=factor(dep_val),y=mean_val,color=type_R0,group=interaction(type_R0))) + #,size=seasforce_peak
geom_point(position=position_dodge(width=dodge_val)) + scale_size(range=c(0.7,2)/3.5) +
geom_pointrange(aes(ymin=min_npi_val,ymax=max_npi_val),position=position_dodge(width=dodge_val)) +
facet_wrap(~age_yr,scales="free",nrow=3) + scale_color_manual(values=colorpal) +
geom_vline(xintercept=0.5+(0:8),linetype="dashed",size=1/3) + # guides(color=guide_legend(ncol=5,byrow=TRUE)) +
xlab("dependence on age/exp") + ylab(paste0("forward shift in season ",ifelse(grepl("start",sel_var),"start","peak")," (weeks)")) +
labs(size="seasonal forcing (+baseline)",color="") + theme_bw() + standard_theme  + scale_x_discrete(expand=expansion(0.1,0)) +
theme(legend.position="top",axis.title.x=element_text(size=18),axis.title.y=element_text(size=18),legend.title=element_text(size=14),
axis.text.x=element_text(size=16),axis.text.y=element_text(size=16),strip.text=element_text(size=15),legend.text=element_text(size=13))
ggsave(paste0(foldername,"resurgence_shift_",ifelse(grepl("start",sel_var),"start","peak"),"week_2021_2019_agegr_yrly_seasfor_aver.png"),
width=40,height=30,units="cm")
npi_dates
rsv_age_groups
0.000030
dim(partable)
head(partable,2)
as.numeric(partable[k_par,] %>% ungroup() %>% select(contains("delta")) )
for (k_par in 1:nrow(parsets_filtered)){
if (k_par==1) {susc_all=data.frame()}
delta_primary <- as.numeric(partable[k_par,] %>% ungroup() %>% select(contains("delta")) )
agedep_fact<-left_join(parsets_filtered,partable,by=c("par_id","dep_val","dep_type","seasforce_peak","R0"))[k_par,]$agedep_val
g(delta_susc,delta_susc_prop) %=% fcn_delta_susc(delta_primary,n_age,n_inf,agedep_fact,rsv_age_groups$stationary_popul)
df <- data.frame(t(round(delta_susc_prop,5))); colnames(df) <-c("inf #1","inf #2","inf #3")
df <- bind_cols(df,parsets_filtered[k_par,]) %>% rowid_to_column("agegr_no") %>%
mutate(agegroup=factor(rsv_age_groups$agegroup_name,levels=unique(rsv_age_groups$agegroup_name)))
if (k_par==1) {susc_all=df} else {susc_all=rbind(susc_all,df)
}
}
dim(susc_all)
ggplot(susc_all %>% group_by(dep_type,dep_val,agegroup) %>% filter(R0==min(R0)) %>% pivot_longer(c(`inf #1`,`inf #2`,`inf #3`)) %>%
mutate(name=gsub("inf","infection",name)) %>% rename(`strength of dependence`=dep_val)) +
geom_hpline(aes(x=agegroup,y=value,group=interaction(`strength of dependence`,name),color=factor(name)),
width=0.95/3,size=1,position=position_dodge(width=1)) +
facet_grid(`strength of dependence`~dep_type,labeller=labeller(`strength of dependence`=label_both)) +
geom_vline(xintercept=0.5+(0:11),size=1/3,linetype="dashed") +
scale_y_log10(expand=expansion(0.04,0)) + scale_x_discrete(expand=expansion(0.02,0)) +
theme_bw() + standard_theme + theme(legend.text=element_text(size=14)) + ylab("susceptibility to infection") + labs(color="",linetype="") +
guides(color=guide_legend(byrow=TRUE)) # ncol=3,
dim(susc_all)
head(susc_all,2)
for (k_par in 1:nrow(parsets_filtered)){
if (k_par==1) {susc_all=data.frame()}
delta_primary <- as.numeric(partable[k_par,] %>% ungroup() %>% select(contains("delta")) )
g(delta_susc,delta_susc_prop) %=% fcn_delta_susc(delta_primary,n_age,n_inf,partable$agedep_val[k_par],rsv_age_groups$stationary_popul)
df <- data.frame(t(round(delta_susc_prop,5))); colnames(df) <-c("inf #1","inf #2","inf #3")
df <- bind_cols(df,partable[k_par,]) %>% rowid_to_column("agegr_no") %>%
mutate(agegroup=factor(rsv_age_groups$agegroup_name,levels=unique(rsv_age_groups$agegroup_name)))
if (k_par==1) {susc_all=df} else {susc_all=rbind(susc_all,df)
}
}
dim(susc_all)
ggplot(susc_all %>% group_by(dep_type,dep_val,agegroup) %>% filter(R0==min(R0)) %>% pivot_longer(c(`inf #1`,`inf #2`,`inf #3`)) %>%
mutate(name=gsub("inf","infection",name)) %>% rename(`strength of dependence`=dep_val)) +
geom_hpline(aes(x=agegroup,y=value,group=interaction(`strength of dependence`,name),color=factor(name)),
width=0.95/3,size=1,position=position_dodge(width=1)) +
facet_grid(`strength of dependence`~dep_type,labeller=labeller(`strength of dependence`=label_both)) +
geom_vline(xintercept=0.5+(0:11),size=1/3,linetype="dashed") +
scale_y_log10(expand=expansion(0.04,0)) + scale_x_discrete(expand=expansion(0.02,0)) +
theme_bw() + standard_theme + theme(legend.text=element_text(size=14)) + ylab("susceptibility to infection") + labs(color="",linetype="") +
guides(color=guide_legend(byrow=TRUE)) # ncol=3,
k_par
if (k_par==1) {susc_all=data.frame()}
delta_primary <- as.numeric(partable[k_par,] %>% ungroup() %>% select(contains("delta")) )
g(delta_susc,delta_susc_prop) %=% fcn_delta_susc(delta_primary,n_age,n_inf,partable$agedep_val[k_par],rsv_age_groups$stationary_popul)
df <- data.frame(t(round(delta_susc_prop,5))); colnames(df) <-c("inf #1","inf #2","inf #3")
df
df <- bind_cols(df,partable[k_par,]) %>% rowid_to_column("agegr_no") %>%
mutate(agegroup=factor(rsv_age_groups$agegroup_name,levels=unique(rsv_age_groups$agegroup_name)))
head(df,3)
partable[k_par,]
unique(partable$dep_val)
df
k_par
k_par=1
if (k_par==1) {susc_all=data.frame()}
delta_primary <- as.numeric(partable[k_par,] %>% ungroup() %>% select(contains("delta")) )
g(delta_susc,delta_susc_prop) %=% fcn_delta_susc(delta_primary,n_age,n_inf,partable$agedep_val[k_par],rsv_age_groups$stationary_popul)
df <- data.frame(t(round(delta_susc_prop,5))); colnames(df) <-c("inf #1","inf #2","inf #3")
df <- bind_cols(df,partable[k_par,]) %>% rowid_to_column("agegr_no") %>%
mutate(agegroup=factor(rsv_age_groups$agegroup_name,levels=unique(rsv_age_groups$agegroup_name)))
df
for (k_par in 1:nrow(partable)){
if (k_par==1) {susc_all=data.frame()}
delta_primary <- as.numeric(partable[k_par,] %>% ungroup() %>% select(contains("delta")) )
g(delta_susc,delta_susc_prop) %=% fcn_delta_susc(delta_primary,n_age,n_inf,partable$agedep_val[k_par],rsv_age_groups$stationary_popul)
df <- data.frame(t(round(delta_susc_prop,5))); colnames(df) <-c("inf #1","inf #2","inf #3")
df <- bind_cols(df,partable[k_par,]) %>% rowid_to_column("agegr_no") %>%
mutate(agegroup=factor(rsv_age_groups$agegroup_name,levels=unique(rsv_age_groups$agegroup_name)))
if (k_par==1) {susc_all=df} else {susc_all=rbind(susc_all,df)
}
}
dim(susc_all)
ggplot(susc_all %>% group_by(dep_type,dep_val,agegroup) %>% filter(R0==min(R0)) %>% pivot_longer(c(`inf #1`,`inf #2`,`inf #3`)) %>%
mutate(name=gsub("inf","infection",name)) %>% rename(`strength of dependence`=dep_val)) +
geom_hpline(aes(x=agegroup,y=value,group=interaction(`strength of dependence`,name),color=factor(name)),
width=0.95/3,size=1,position=position_dodge(width=1)) +
facet_grid(`strength of dependence`~dep_type,labeller=labeller(`strength of dependence`=label_both)) +
geom_vline(xintercept=0.5+(0:11),size=1/3,linetype="dashed") +
scale_y_log10(expand=expansion(0.04,0)) + scale_x_discrete(expand=expansion(0.02,0)) +
theme_bw() + standard_theme + theme(legend.text=element_text(size=14)) + ylab("susceptibility to infection") + labs(color="",linetype="") +
guides(color=guide_legend(byrow=TRUE)) # ncol=3,
ggplot(susc_all %>% group_by(dep_type,dep_val,agegroup) %>% filter(R0==min(R0)) %>% pivot_longer(c(`inf #1`,`inf #2`,`inf #3`)) %>%
mutate(name=gsub("inf","infection",name)) %>% rename(dependence=dep_val)) +
geom_hpline(aes(x=agegroup,y=value,group=interaction(dependence,name),color=factor(name)),
width=0.95/3,size=1,position=position_dodge(width=1)) +
facet_grid(dependence~dep_type,labeller=labeller(dependence=label_both)) +
geom_vline(xintercept=0.5+(0:11),size=1/3,linetype="dashed") +
scale_y_log10(expand=expansion(0.04,0)) + scale_x_discrete(expand=expansion(0.02,0)) +
theme_bw() + standard_theme + theme(legend.text=element_text(size=14)) + ylab("susceptibility to infection") + labs(color="",linetype="") +
guides(color=guide_legend(byrow=TRUE)) # ncol=3,
ggsave(paste0(foldername,"susceptibility_params_ALL.png"),width=25,height=30,units="cm")
ggplot(susc_all %>% group_by(dep_type,dep_val,agegroup) %>% filter(R0==min(R0)) %>% pivot_longer(c(`inf #1`,`inf #2`,`inf #3`)) %>%
mutate(name=gsub("inf","infection",name)) %>% rename(dependence=dep_val)) +
geom_hpline(aes(x=agegroup,y=value,group=interaction(dependence,name),color=factor(name)),
width=0.95/3,size=1,position=position_dodge(width=1)) +
facet_grid(dependence~dep_type,labeller=labeller(dependence=label_both)) +
geom_vline(xintercept=0.5+(0:11),size=1/3,linetype="dashed") +
scale_y_log10(expand=expansion(0.04,0)) + scale_x_discrete(expand=expansion(0.02,0)) +
theme_bw() + standard_theme+ ylab("susceptibility to infection") + labs(color="",linetype="") +
guides(color=guide_legend(byrow=TRUE))  + theme(legend.text=element_text(size=14),
axis.title.x=element_text(size=16),axis.title.y=element_text(size=16),axis.text.x=element_text(size=16),axis.text.y=element_text(size=16),
strip.text = element_text(size=16))
#
ggsave(paste0(foldername,"susceptibility_params_ALL.png"),width=25,height=30,units="cm")
ggplot(susc_all %>% group_by(dep_type,dep_val,agegroup) %>% filter(R0==min(R0)) %>% pivot_longer(c(`inf #1`,`inf #2`,`inf #3`)) %>%
mutate(name=gsub("inf","infection",name)) %>% rename(dependence=dep_val)) +
geom_hpline(aes(x=agegroup,y=value,group=interaction(dependence,name),color=factor(name)),
width=0.95/3,size=1,position=position_dodge(width=1)) +
facet_grid(dependence~dep_type,labeller=labeller(dependence=label_both)) +
geom_vline(xintercept=0.5+(0:11),size=1/3,linetype="dashed") +
scale_y_log10(expand=expansion(0.04,0)) + scale_x_discrete(expand=expansion(0.02,0)) +
theme_bw() + standard_theme+ ylab("susceptibility to infection") + labs(color="",linetype="") +
guides(color=guide_legend(byrow=TRUE))  + theme(legend.text=element_text(size=14),
axis.title.x=element_text(size=16),axis.title.y=element_text(size=16),axis.text.x=element_text(size=16),axis.text.y=element_text(size=16),
strip.text.x=element_text(size=16),strip.text.y=element_text(size=15))
#
ggsave(paste0(foldername,"susceptibility_params_ALL.png"),width=25,height=30,units="cm")
ggsave(paste0(foldername,"susceptibility_params_ALL.png"),width=35,height=30,units="cm")
rsv_age_groups$agegroup_name
View(partable)
round(0.02550009,0.02157700,0.01765391,3)
round(c(0.02550009,0.02157700,0.01765391),3)
round(c(0.08089811,0.04683575,0.01277339),3)
View(susc_all %>% filter(dep_type=="age"))
sum(birth_rates)
rsv_age_groups$deaths_per_person_per_day*365
rsv_age_groups$deaths_per_person_per_day*365*1000
rsv_age_groups$stationary_popul
round(rsv_age_groups$stationary_popul/1e3)
popul_struct
rsv_age_groups
round(rsv_age_groups$value/1e3)
joint_dep_vals
unique(df_suscept$dep_val)
df_suscept %>% group_by(dep_type) %>% unique(dep_val)
df_suscept %>% group_by(dep_type) %>% summarise(unique(dep_val))
ggplot(df_suscept %>% # filter(dep_val %in% joint_dep_vals) %>% mutate(dep_val_sel=as.numeric(factor(dep_val))) %>%
group_by(dep_type,dep_val_sel,agegroup) %>% filter(R0==min(R0)) %>% pivot_longer(c(`inf #1`,`inf #2`,`inf #3`)) %>%
mutate(name=gsub("inf","infection",name)) %>% rename(`strength of dependence`=dep_val_sel)) +
geom_hpline(aes(x=agegroup,y=value,group=interaction(`strength of dependence`,name),color=factor(name)),
width=0.95/3,size=1,position=position_dodge(width=1)) +
facet_grid(`strength of dependence`~dep_type,labeller=labeller(`strength of dependence`=label_both)) +
geom_vline(xintercept=0.5+(0:11),size=1/3,linetype="dashed") +
scale_y_log10(expand=expansion(0.04,0)) + scale_x_discrete(expand=expansion(0.02,0)) +
theme_bw() + standard_theme + theme(legend.text=element_text(size=14)) + ylab("susceptibility to infection") + labs(color="",linetype="") +
guides(color=guide_legend(byrow=TRUE)) # ncol=3,
ggplot(df_suscept %>% group_by(dep_type,dep_val_sel,agegroup) %>% filter(R0==min(R0)) %>% pivot_longer(c(`inf #1`,`inf #2`,`inf #3`)) %>%
mutate(name=gsub("inf","infection",name)) %>% rename(dependence=dep_val_sel)) +
geom_hpline(aes(x=agegroup,y=value,group=interaction(dependence,name),color=factor(name)),
width=0.95/3,size=1,position=position_dodge(width=1)) +
facet_grid(dependence~dep_type,labeller=labeller(dependence=label_both)) +
geom_vline(xintercept=0.5+(0:11),size=1/3,linetype="dashed") +
scale_y_log10(expand=expansion(0.04,0)) + scale_x_discrete(expand=expansion(0.02,0)) +
theme_bw() + standard_theme + ylab("susceptibility to infection") + labs(color="",linetype="") +
guides(color=guide_legend(byrow=TRUE))  + theme(legend.text=element_text(size=14),legend.title=element_text(size=14),
axis.text.x=element_text(size=14),axis.text.y=element_text(size=14),strip.text=element_text(size=15),legend.text=element_text(size=13))
ggplot(df_suscept %>% group_by(dep_type,dep_val_sel,agegroup) %>% filter(R0==min(R0)) %>% pivot_longer(c(`inf #1`,`inf #2`,`inf #3`)) %>%
mutate(name=gsub("inf","infection",name)) %>% rename(dependence=dep_val_sel)) +
geom_hpline(aes(x=agegroup,y=value,group=interaction(dependence,name),color=factor(name)),
width=0.95/3,size=1,position=position_dodge(width=1)) +
facet_grid(dependence~dep_type,labeller=labeller(dependence=label_both)) +
geom_vline(xintercept=0.5+(0:11),size=1/3,linetype="dashed") +
scale_y_log10(expand=expansion(0.04,0)) + scale_x_discrete(expand=expansion(0.02,0)) +
theme_bw() + standard_theme + ylab("susceptibility to infection") + labs(color="",linetype="") +
guides(color=guide_legend(byrow=TRUE))  + theme(legend.text=element_text(size=14),legend.title=element_text(size=14),
axis.text.x=element_text(size=14),axis.text.y=element_text(size=14),strip.text=element_text(size=15))
ggsave(paste0(foldername,"susceptibility_params.png"),width=28,height=16,units="cm")
ggsave(paste0(foldername,"susceptibility_params.png"),width=28,height=22,units="cm")
ggplot(df_seas_forc_npi %>% filter(date<=as.Date("2022-07-01")),aes(x=date,y=value,color=name)) + geom_line(size=1.05) +
geom_vline(data=df_seas_forc_npi %>% filter(week %in% c(7,42) & name=="1") %>% group_by(week,year) %>% filter(date==min(date)),
aes(xintercept=date),linetype="dashed",color="black",size=1/4,show.legend=F) + labs(color="contacts during NPIs (% normal)") +
scale_x_date(date_breaks="2 month",expand=expansion(0.01,0)) + theme_bw() + standard_theme + xlab("") + ylab("strength of forcing") +
geom_rect(xmin=npi_dates[1],xmax=npi_dates[2],ymin=-Inf,ymax=Inf,fill="grey",alpha=0.01,show.legend=F,color=NA) +
theme(axis.text.x=element_text(size=14),axis.text.y=element_text(size=14),legend.text=element_text(size=14),legend.position="top",
legend.title=element_text(size=16),axis.title.y=element_text(size=15))
ggsave(paste0(foldername,"seasonal_forcing_NPI_contactlevel.png"),width=32,height=22,units="cm")
resp_virus_data_uk=read_csv("data/Respiratory viral detections by any method UK Ages.csv")
resp_virus_data_uk_tidy = resp_virus_data_uk %>% pivot_longer(!c("Year","startweek","Age")) %>%
mutate(Age=factor(gsub(" Y","Y",Age),levels=unique(gsub(" Y","Y",Age))))
leaveout_year=c(2014); truthvals_rsv=resp_virus_data_uk_tidy$name %in% "RSV" & (!resp_virus_data_uk_tidy$Year %in% leaveout_year)
# means across years
averages_years=data.frame(resp_virus_data_uk_tidy[truthvals_rsv,] %>% group_by(startweek,Age) %>%
summarise(value=mean(value)),Year='mean',name='RSV')
if (!any(resp_virus_data_uk_tidy$Year %in% "mean")){
resp_virus_data_uk_tidy=rbind(resp_virus_data_uk_tidy,averages_years[,colnames(resp_virus_data_uk_tidy)])}
truthvals_rsv=(resp_virus_data_uk_tidy$name %in% "RSV") & resp_virus_data_uk_tidy$Year %in% c("mean",2020)
# (!resp_virus_data_uk_tidy$Year %in% c(leaveout_year,))
resp_virus_data_uk_tidy[,"type"]="indiv year"; resp_virus_data_uk_tidy[resp_virus_data_uk_tidy$Year %in% "mean","type"]="5-year average"
resp_virus_data_uk_tidy[,"width"]=1.01; resp_virus_data_uk_tidy[resp_virus_data_uk_tidy$Year %in% "mean","width"]=1.015
# convert weel number to date
resp_virus_data_uk_tidy[,"date"]=as.Date(paste(resp_virus_data_uk_tidy$Year,resp_virus_data_uk_tidy$startweek,1,sep="-"),"%Y-%U-%u")
resp_virus_data_uk_tidy[,"year_week"]=gsub("mean-","",paste0(resp_virus_data_uk_tidy$Year,"-",resp_virus_data_uk_tidy$startweek))
resp_virus_data_uk_tidy$year_week=factor(resp_virus_data_uk_tidy$year_week,unique(resp_virus_data_uk_tidy$year_week))
# PLOT all years
ggplot(subset(resp_virus_data_uk_tidy,name %in% "RSV" & grepl("indiv",type)),aes(x=date,y=value,group=Age)) +
geom_area(aes(fill=Age),position=position_stack(reverse=T)) +
# geom_line(aes(color=Age)) + geom_point(size=0.4) + facet_wrap(~Age,ncol=2,scales="free") + #
scale_x_date(breaks="2 month",expand=expansion(0.01,0)) + scale_y_continuous(expand=expansion(0.01,0)) +
ylab("number of reported RSV cases (4-week period)") + theme_bw() + standard_theme + # xlab("Year, week")  +
theme(axis.text.x=element_text(size=10),axis.text.y=element_text(size=11),legend.position="bottom")
ggplot(subset(resp_virus_data_uk_tidy,name %in% "RSV" & grepl("indiv",type)),aes(x=date,y=value,group=Age)) +
geom_area(aes(fill=Age),position=position_stack(reverse=T),color="black",size=1/4) +
# geom_line(aes(color=Age)) + geom_point(size=0.4) + facet_wrap(~Age,ncol=2,scales="free") + #
scale_x_date(breaks="2 month",expand=expansion(0.01,0)) + scale_y_continuous(expand=expansion(0.01,0)) +
ylab("number of reported RSV cases (4-week period)") + theme_bw() + standard_theme + # xlab("Year, week")  +
theme(axis.text.x=element_text(size=10),axis.text.y=element_text(size=11),legend.position="bottom")
ggplot(subset(resp_virus_data_uk_tidy,name %in% "RSV" & grepl("indiv",type)),aes(x=date,y=value,group=Age)) +
geom_area(aes(fill=Age),position=position_stack(reverse=T),color="black",size=1/4) +
# geom_line(aes(color=Age)) + geom_point(size=0.4) + facet_wrap(~Age,ncol=2,scales="free") + #
scale_x_date(breaks="2 month",expand=expansion(0.01,0)) + scale_y_continuous(expand=expansion(0.01,0)) +
ylab("number of reported RSV cases (4-week period)") + theme_bw() + standard_theme + xlab("")  +
theme(axis.text.x=element_text(size=10),axis.text.y=element_text(size=11),legend.position="bottom")
ggplot(subset(resp_virus_data_uk_tidy,name %in% "RSV" & grepl("indiv",type)),aes(x=date,y=value,group=Age)) +
geom_area(aes(fill=Age),position=position_stack(reverse=T),color="black",size=1/4) +
# geom_line(aes(color=Age)) + geom_point(size=0.4) + facet_wrap(~Age,ncol=2,scales="free") + #
scale_x_date(breaks="2 month",expand=expansion(0.01,0)) + scale_y_continuous(expand=expansion(0.01,0)) +
ylab("number of reported RSV cases") + theme_bw() + standard_theme + xlab("")  +
theme(axis.text.x=element_text(size=10),axis.text.y=element_text(size=11),legend.position="bottom")
ggsave("simul_output/uk_rsv_data2014_2020.png",width=32,height=16,units="cm")
ggplot(subset(resp_virus_data_uk_tidy,name %in% "RSV" & grepl("indiv",type)),aes(x=date,y=value,group=Age)) +
geom_area(aes(fill=Age),position=position_stack(reverse=T),color="black",size=1/4) +
# geom_line(aes(color=Age)) + geom_point(size=0.4) + facet_wrap(~Age,ncol=2,scales="free") + #
scale_x_date(breaks="2 month",expand=expansion(0.01,0)) + scale_y_continuous(expand=expansion(0.01,0)) +
ylab("number of reported RSV cases") + theme_bw() + standard_theme + xlab("")  +
theme(axis.text.x=element_text(size=13),axis.text.y=element_text(size=13),legend.position="bottom",legend.text=element_text(size=14),
axis.title.y=element_text(size=15))
ggsave("data/uk_rsv_data2014_2020.png",width=32,height=22,units="cm")
ggplot(subset(resp_virus_data_uk_tidy,name %in% "RSV" & grepl("indiv",type)),aes(x=date,y=value,group=Age)) +
geom_area(aes(fill=Age),position=position_stack(reverse=T),color="black",size=1/4) +
# geom_line(aes(color=Age)) + geom_point(size=0.4) + facet_wrap(~Age,ncol=2,scales="free") + #
scale_x_date(breaks="2 month",expand=expansion(0.01,0)) + scale_y_continuous(expand=expansion(0.01,0)) +
ylab("number of reported RSV cases") + theme_bw() + standard_theme + xlab("")  + labs(color="") +
theme(axis.text.x=element_text(size=13),axis.text.y=element_text(size=13),legend.position="bottom",legend.text=element_text(size=14),
axis.title.y=element_text(size=15))
ggplot(subset(resp_virus_data_uk_tidy,name %in% "RSV" & grepl("indiv",type)),aes(x=date,y=value,group=Age)) +
geom_area(aes(fill=Age),position=position_stack(reverse=T),color="black",size=1/4) +
# geom_line(aes(color=Age)) + geom_point(size=0.4) + facet_wrap(~Age,ncol=2,scales="free") + #
scale_x_date(breaks="2 month",expand=expansion(0.01,0)) + scale_y_continuous(expand=expansion(0.01,0)) +
ylab("number of reported RSV cases") + theme_bw() + standard_theme + xlab("")  + labs(fill="") +
theme(axis.text.x=element_text(size=13),axis.text.y=element_text(size=13),legend.position="bottom",legend.text=element_text(size=14),
axis.title.y=element_text(size=15))
ggsave("data/uk_rsv_data2014_2020.png",width=32,height=22,units="cm")
ggplot(subset(resp_virus_data_uk_tidy,name %in% "RSV" & grepl("indiv",type)),aes(x=date,y=value,group=Age)) +
geom_area(aes(fill=Age),position=position_stack(reverse=T),color="black",size=1/4) +
# geom_line(aes(color=Age)) + geom_point(size=0.4) + facet_wrap(~Age,ncol=2,scales="free") + #
scale_x_date(breaks="2 month",expand=expansion(0.01,0)) + scale_y_continuous(expand=expansion(0.01,0)) +
ylab("number of reported RSV cases") + theme_bw() + standard_theme + xlab("")  + labs(fill="") +
theme(axis.text.x=element_text(size=13),axis.text.y=element_text(size=14),legend.position="bottom",legend.text=element_text(size=15),
axis.title.y=element_text(size=16))
#  labs(caption="source: gov.uk/health-and-social-care/health-protection-infectious-diseases")
ggsave("data/uk_rsv_data2014_2020.png",width=32,height=22,units="cm")
rsv_age_groups$value/rsv_age_groups$stationary_popul
round(rsv_age_groups$stationary_popul/rsv_age_groups$value,2)
round(abs(rsv_age_groups$stationary_popul-rsv_age_groups$value)/rsv_age_groups$value,2)
round(abs(rsv_age_groups$stationary_popul-rsv_age_groups$value)/sum(rsv_age_groups$value),2)
round(100*abs(rsv_age_groups$stationary_popul-rsv_age_groups$value)/sum(rsv_age_groups$value),2)
abs(rsv_age_groups$stationary_popul-rsv_age_groups$value)/1e3
varname <- "sum_ratio"; dodge_val=1
title_str <- ifelse(!grepl("ratio",varname),"shift in peak incidence week","ratio of cumulative infections 2021 to 2019")
# plot
ggplot(df_plot_yr_cum_inf,aes(x=factor(dep_val),y=mean_val,color=type_R0,group=interaction(seasforce_peak,type_R0),size=seasforce_peak)) + #
geom_point(position=position_dodge(width=dodge_val)) + scale_size(range=c(0.7,2)/3) +
geom_pointrange(aes(ymin=min_npi_val,ymax=max_npi_val),position=position_dodge(width=dodge_val)) +
facet_wrap(~age_yr,scales="free",nrow=3) + scale_color_manual(values=colorpal) +
geom_vline(xintercept=0.5+(0:8),linetype="dashed",size=1/3) + # guides(color=guide_legend(ncol=5,byrow=TRUE)) +
xlab("dependence on age/immunity") + ylab(title_str) + labs(size="seasonal forcing (+ baseline)",color="") +
theme_bw() + standard_theme  + scale_x_discrete(expand=expansion(0.1,0)) + theme(legend.position="top",
axis.title.x=element_text(size=16),axis.title.y=element_text(size=16),axis.text.x=element_text(size=16),axis.text.y=element_text(size=16),
strip.text=element_text(size=15),legend.text=element_text(size=13),legend.title=element_text(size=14))
ggsave(paste0(foldername,"resurgence_",varname,"_2021_2019_agegr_yrly_seasfor_sep.png"),width=40,height=30,units="cm")
ggsave(paste0(foldername,"resurgence_",varname,"_2021_2019_agegr_yrly_seasfor_sep.png"),width=43,height=30,units="cm")
ggsave(paste0(foldername,"resurgence_",varname,"_2021_2019_agegr_yrly_seasfor_sep.png"),width=45,height=30,units="cm")
df_plot_yr_seas_timing <- sum_max_ratio_by_yearly_agegr %>% filter(epi_year==2021 & !grepl(">15y",age_yr)) %>%
mutate(dep_type=ifelse(grepl("age",dep_type),"~age","~immunity")) %>% ungroup() %>%
group_by(age_yr,dep_type,dep_val,R0,seasforce_peak) %>% #
summarise(mean_val=abs(mean(!!sym(sel_var))),min_npi_val=abs(min(!!sym(sel_var))),max_npi_val=abs(max(!!sym(sel_var))) ) %>% ungroup() %>%
mutate(type_R0=factor(paste0(dep_type,", R0=",R0)) )
#  filter(dep_val %in% joint_dep_vals) %>% mutate(dep_val=as.numeric(factor(dep_val))) %>%
# seas timing
ggplot(df_plot_yr_seas_timing,aes(x=factor(dep_val),y=mean_val,color=type_R0,group=interaction(seasforce_peak,type_R0),size=seasforce_peak)) + #
geom_point(position=position_dodge(width=dodge_val)) + scale_size(range=c(0.7,2)/3.5) +
geom_pointrange(aes(ymin=min_npi_val,ymax=max_npi_val),position=position_dodge(width=dodge_val)) +
facet_wrap(~age_yr,scales="free",nrow=3) + scale_color_manual(values=colorpal) +
geom_vline(xintercept=0.5+(0:8),linetype="dashed",size=1/3) + # guides(color=guide_legend(ncol=5,byrow=TRUE)) +
xlab("dependence on age/exp") + ylab(paste0("forward shift in season ",ifelse(grepl("start",sel_var),"start","peak")," (weeks)")) +
labs(size="seasonal forcing (+baseline)",color="") + theme_bw() + standard_theme  + scale_x_discrete(expand=expansion(0.1,0)) +
theme(legend.position="top",axis.title.x=element_text(size=18),axis.title.y=element_text(size=18),legend.title=element_text(size=14),
axis.text.x=element_text(size=16),axis.text.y=element_text(size=16),strip.text=element_text(size=15),legend.text=element_text(size=13))
paste0(foldername,"resurgence_shift_",ifelse(grepl("start",sel_var),"start","peak"),"week_2021_2019_agegr_yrly_seasfor_aver.png")
ggsave(paste0(foldername,"resurgence_shift_",ifelse(grepl("start",sel_var),"start","peak"),"week_2021_2019_agegr_yrly_seasfor_aver.png"),
width=40,height=30,units="cm")
unique(df_plot_yr_seas_timing$seasforce_peak)
ggsave(paste0(foldername,"resurgence_shift_",ifelse(grepl("start",sel_var),"start","peak"),"week_2021_2019_agegr_yrly_seasfor_separate.png"),
width=40,height=30,units="cm")
df_plot_yr_seas_timing <- sum_max_ratio_by_yearly_agegr %>% filter(epi_year==2021 & !grepl(">15y",age_yr)) %>%
mutate(dep_type=ifelse(grepl("age",dep_type),"~age","~immunity")) %>% ungroup() %>%
group_by(age_yr,dep_type,dep_val,R0,seasforce_peak) %>% #
summarise(mean_val=abs(mean(!!sym(sel_var))),min_npi_val=abs(min(!!sym(sel_var))),max_npi_val=abs(max(!!sym(sel_var))) ) %>% ungroup() %>%
mutate(type_R0=factor(paste0(dep_type,", R0=",R0)) )
# seas timing
ggplot(df_plot_yr_seas_timing,aes(x=factor(dep_val),y=mean_val,color=type_R0,group=interaction(seasforce_peak,type_R0),size=seasforce_peak)) + #
geom_point(position=position_dodge(width=dodge_val)) + scale_size(range=c(0.7,2)/3.5) +
geom_pointrange(aes(ymin=min_npi_val,ymax=max_npi_val),position=position_dodge(width=dodge_val)) +
facet_wrap(~age_yr,scales="free",nrow=3) + scale_color_manual(values=colorpal) +
geom_vline(xintercept=0.5+(0:8),linetype="dashed",size=1/3) + # guides(color=guide_legend(ncol=5,byrow=TRUE)) +
xlab("dependence on age/exp") + ylab(paste0("forward shift in season ",ifelse(grepl("start",sel_var),"start","peak")," (weeks)")) +
labs(size="seasonal forcing (+baseline)",color="") + theme_bw() + standard_theme  + scale_x_discrete(expand=expansion(0.1,0)) +
theme(legend.position="top",axis.title.x=element_text(size=18),axis.title.y=element_text(size=18),legend.title=element_text(size=14),
axis.text.x=element_text(size=16),axis.text.y=element_text(size=16),strip.text=element_text(size=15),legend.text=element_text(size=13))
ggsave(paste0(foldername,"resurgence_shift_",ifelse(grepl("start",sel_var),"start","peak"),"week_2021_2019_agegr_yrly_seasfor_separate.png"),
width=40,height=30,units="cm")
ggsave(paste0(foldername,"resurgence_shift_",ifelse(grepl("start",sel_var),"start","peak"),"week_2021_2019_agegr_yrly_seasfor_sep.png"),
width=45,height=30,units="cm")
